---
title: "Simcoin multi-run Report"
date: '`r format(Sys.time(), "%d %B, %Y")`'
author: "simcoin"
output:
  pdf_document:
    pandoc_args:
      - -V
      - classoption=twocolumn
    toc: yes
  html_document:
    toc: yes
---

```{r knitr_options, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  fig.path='RmdFigs/',
  warning=FALSE,
  message=FALSE,
  error = TRUE,
  echo = FALSE,
  dev = 'pdf',
  fig.align='center'
  )

# set working directory for development: knitr::opts_knit$set(root.dir = '/tmp/multi_run/')
```

```{r setup, include=FALSE}
library(jsonlite)
library(anytime)
library(dplyr)
library(kableExtra)
library(lattice)
library(reshape2)
library(stringr)
Sys.setenv(TZ='UTC')

general_infos <- fromJSON(file('run-1/general_infos.json'))
tick_infos    <- read.csv2("tick_infos.csv", dec=".")
step_times    <-  read.csv2("step_times.csv", dec=".")

ticks <- readLines('ticks.csv')

txs             <- read.csv2("txs.csv", dec=".")
blocks          <- read.csv2("blocks.csv", dec=".")
tips            <- read.csv2("tips.csv", dec=".")
consensus_chain <- read.csv2("consensus_chain.csv", dec=".")

blocks_received <- read.csv2("blocks_received.csv", dec=".")
txs_received    <- read.csv2("txs_received.csv", dec=".")

tx_exces    <- read.csv2("tx_exceptions.csv", dec=".")
block_exces <- read.csv2("block_exceptions.csv", dec=".")
rpc_exces   <- read.csv2("rpc_exceptions.csv", dec=".")

cpu_time <- read.csv2("cpu_time.csv", dec=".")
memory <- read.csv2("memory.csv", dec=".")

args      <- stream_in(file('args.json'))
sim_start <- tick_infos$start[1]
```

## Simulation
```{r start_arguments}
args_transposed <- as.data.frame(t(args))
kable(args_transposed, col.names = c('Value'), format = 'latex', caption ='Start arguments') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r events_summary}
planned_blocks <- sum(str_count(ticks, 'block'))
planned_txs    <- sum(str_count(ticks, 'tx'))
df             <- data.frame(
                    c(length(ticks), data.frame(table(tick_infos$tag))[,2]),
                    c(planned_blocks, data.frame(table(blocks$tag))[,2]),
                    c(planned_txs, data.frame(table(txs$tag))[,2] - data.frame(table(blocks$tag))[,2])
                  )
row.names(df)  <- c('Planned', levels(data.frame(table(tick_infos$tag))[,1]))
kable(df,
      col.names = c('Ticks', 'Blocks', 'Transactions'), caption = 'Events summary', format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

## System

```{r system_information}
kable(Sys.info(), col.names = c('Value'), format = 'latex', caption = 'System information') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r system_hardware_specs}
infos <- data.frame(c(general_infos$cpu_model, general_infos$cpus, round(as.double(general_infos$total_memory) / 1000000, 3)))
row.names(infos) <- c('CPU model', 'CPU(s)', 'Memory [GB]')
kable(infos, col.names = c('Value'), format = 'latex', caption = 'System hardware specs') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

## Ticks

```{r simulation_starts}
simulation_starts           <- aggregate(tick_infos$timestamp, by=list(tick_infos$tag), FUN=min)
colnames(simulation_starts) <- c('tag', 'run_start')
```

```{r tick_duration_summary}
kable(unclass(summary(tick_infos$duration)), col.names = c('Duration [s]'), digits = 3, caption = 'Overall tick duration', format = 'latex')  %>%
  kable_styling(latex_options = c('HOLD_position'))
```

## Blocks

```{r block_propagation_summary}
blocks_received <- merge(blocks[, c('timestamp', 'hash')], blocks_received, by = 'hash')
blocks_received$propagation_duration <- blocks_received$timestamp.y - blocks_received$timestamp.x

kable(unclass(summary(blocks_received$propagation_duration * 1000)), col.names = c('Propagation [ms]'), digits = 3, caption = 'Overall block propagation', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r block_size_summary}
kable(unclass(summary(blocks$total_size / 1000)), col.names = c('Size [kB]'), digits = 3, caption = 'Overall block size', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r block_stale_rate_summary}
consensus_chain$stale = 'Accepted'
blocks <- merge(blocks, consensus_chain, all.x = TRUE)
blocks$stale[is.na(blocks$stale)] <- 'Stale'

stale_block <- table(blocks$tag, factor(blocks$stale, levels = c('Accepted', 'Stale')))
stale_rate  <- data.frame(c(round(prop.table(stale_block, 1)[,2] * 100, 3)))
kable(stale_rate, col.names = c('Rate [%]'), digits = 3, caption = 'Stale block rate', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

## Transactions

```{r txs_propagation_summary}
txs_received <- merge(txs[, c('timestamp', 'hash')], txs_received, by = 'hash')
txs_received$propagation_duration <- txs_received$timestamp.y - txs_received$timestamp.x

kable(unclass(summary(txs_received$propagation_duration * 1000)), col.names = c('Propagation [ms]'), digits = 3, caption = 'Overall transactions propagation', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r txs_per_block_summary}
kable(unclass(summary(blocks$txs)), digits = 0, caption = 'Overall transactions per block', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

## Nodes

```{r tips}
kable(tips, format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
not_active_tips <- tips[!(tips$status=='active'),]
```

\clearpage

```{r cpu_time_plot, fig.cap='CPU usage over time', fig.env='figure*', fig.height=3}
cpu_time$total <- cpu_time$user + cpu_time$nice + cpu_time$system
cpu_time_diff <- cpu_time %>%
 group_by(tag) %>%
 mutate(diff = c(NA, diff(idle))) %>%
 filter(!is.na(diff))
cpu_time_diff$usage   <- (1 - cpu_time_diff$idle / (cpu_time_diff$total + cpu_time_diff$idle)) * 100
cpu_time_diff         <- merge(cpu_time_diff, simulation_starts)
cpu_time_diff$elapsed <- cpu_time_diff$timestamp - cpu_time_diff$run_start
xyplot(cpu_time_diff$usage ~ cpu_time_diff$elapsed, groups = cpu_time_diff$tag,
       auto.key = list(space = "top", columns = 2, points = FALSE, lines = TRUE),
       xlab = 'Time [s]', ylab = 'CPU usage [%]', t = 'l' )
```

```{r memory_xyplot, fig.cap='Memory usage over time', fig.env='figure*', fig.height=3}
memory$usage   <- (1 - memory$free/memory$total) * 100
memory         <- merge(memory, simulation_starts)
memory$elapsed <- memory$timestamp - memory$run_start
xyplot(memory$usage ~ memory$elapsed, groups = memory$tag,
       auto.key = list(space = "top", columns = 2, points = FALSE, lines = TRUE),
       xlab = 'Time [s]', ylab = 'Memory usage [%]', t = 'l' )
```


```{r step_times_barchart, fig.cap='Step times', fig.env='figure*', fig.height=length(unique(step_times$tag)) + 1}
step_diff <- step_times %>%
  group_by(tag) %>%
  mutate(diff = c(NA, diff(timestamp))) %>%
  filter(!is.na(diff))
step_diff <- dcast(step_diff, tag~type, value.var = 'diff')
rownames(step_diff) <- step_diff[,1]
step_diff           <- step_diff[,-1]
step_diff           <- step_diff[, c(3,2,1)]
colnames(step_diff) <- c('Preparation', 'Simulation', 'Postprocessing')
barchart(as.matrix(step_diff), stack = TRUE, ref = FALSE, xlab = 'Time [s]',
         auto.key = list(columns=2, rectangles = TRUE, points = FALSE, space='top', text=colnames(step_diff)),
         panel=function(x,y,...){
      panel.barchart(x,y,...)
      xx <- unsplit(unname(lapply(split(x, y), function(t)cumsum(t)-t/2)), y)
      ltext(xx, y=y, labels=round(x, 1))
})
```

```{r tick_duration_xyplot, fig.cap='Tick duration over time', fig.env='figure*'}
ticks         <- merge(tick_infos, simulation_starts)
ticks$elapsed <- ticks$timestamp - ticks$run_start
xyplot(tick_infos$duration ~ ticks$elapsed, groups = ticks$tag,
       auto.key = list(space = "top", columns = 2, points = FALSE, lines = TRUE),
       xlab = 'Time [s]', ylab = 'Duration [s]', t = 'l')
```

```{r tick_duration_median, fig.cap='Tick duration', fig.env='figure*'}
bwplot(tick_infos$duration ~ tick_infos$tag, ylab = 'Duration [s]')
```

```{r block_stale_barchart, fig.cap='Stale blocks', fig.env='figure*', fig.height=length(unique(blocks$tag)) + 1}
stale_block <- table(blocks$tag, blocks$stale)
barchart(stale_block, stack = TRUE, ref = FALSE, xlab = 'Blocks',
         auto.key = list(columns=2, points = FALSE, rectangles = TRUE), panel=function(x,y,...){
      panel.barchart(x,y,...)
      xx <- unsplit(unname(lapply(split(x, y), function(t)cumsum(t)-t/2)), y)
      ltext(xx, y=y, labels=x)
})
```

```{r block_size_bloxplot, fig.cap='Block size', fig.env='figure*'}
bwplot(blocks$total_size / 1000 ~ blocks$tag, ylab = 'Block size [kB]')
```

```{r block_propagation_density, fig.cap='Block propagation density', fig.env='figure*'}
densityplot(~propagation_duration, data=blocks_received, groups = tag,
            auto.key = list(space = "top", columns = 2),
            ref = TRUE, xlab = 'Duration [s]', plot.points = FALSE)
```

```{r block_propagation_boxplot, fig.cap='Block propagation boxplot', fig.env='figure*'}
bwplot(blocks_received$propagation_duration ~ blocks_received$tag, ylab = 'Duration [s]')
```

```{r tx_propagation_density, fig.cap='Transaction propagation density', fig.env='figure*'}
densityplot(~propagation_duration, data=txs_received, groups = tag,
            auto.key = list(space = "top", columns = 2), ref = TRUE,
            xlab = 'Duration [s]', plot.points = FALSE)
```

```{r tx_propagation_boxplot, fig.cap='Transaction propagation boxplot', fig.env='figure*'}
bwplot(txs_received$propagation_duration ~ txs_received$tag, ylab = 'Duration [s]')
```

\clearpage

#### R and package versions used

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
