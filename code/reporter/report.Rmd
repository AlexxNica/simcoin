---
title: "Simcoin run Report"
date: '`r format(Sys.time(), "%d %B, %Y")`'
author: "simcoin"
header-includes:
   - \usepackage{float}
output:
  pdf_document:
    pandoc_args:
      - -V
      - classoption=twocolumn
    toc: yes
---

```{r knitr_options, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  fig.path='RmdFigs/',
  warning=FALSE,
  message=FALSE,
  error = TRUE,
  echo = FALSE,
  dev = 'pdf',
  fig.align='center'
  )

# set working directory for development: knitr::opts_knit$set(root.dir = '/tmp/run/postprocessing/')
```

```{r setup, include=FALSE}
library(jsonlite)
library(anytime)
library(dplyr)
library(kableExtra)
library(lattice)
library(stringr)
Sys.setenv(TZ='UTC')

general_infos <- fromJSON(file('general_infos.json'))
tick_infos    <- read.csv2("tick_infos.csv", dec=".")
step_times    <-  read.csv2("step_times.csv", dec=".")

ticks <- readLines('../ticks.csv')

txs    <- read.csv2("txs.csv", dec=".")
blocks <- read.csv2("blocks.csv", dec=".")
tips   <- read.csv2("tips.csv", dec=".")

memory   <- read.csv2("memory.csv", dec=".")
cpu_time <- read.csv2("cpu_time.csv", dec=".")

blocks_received <- read.csv2("blocks_received.csv", dec=".")
txs_received    <- read.csv2("txs_received.csv", dec=".")

tx_exces    <- read.csv2("tx_exceptions.csv", dec=".")
block_exces <- read.csv2("block_exceptions.csv", dec=".")
rpc_exces   <- read.csv2("rpc_exceptions.csv", dec=".")
log_errors  <- readChar("log_errors.txt", file.info("log_errors.txt")$size)

args      <- stream_in(file('../args.json'))
sim_start <- tick_infos$start[1]
```

## Simulation

```{r general_infos}
general_infos_table <- data.frame(
                    c(format(utctime(step_times$timestamp[1]), '%Y-%m-%d %H:%M:%S %Z'),
                      format(utctime(step_times$timestamp[length(step_times)]), '%Y-%m-%d %H:%M:%S %Z'),
                      general_infos$current_commit)
                  )
row.names(general_infos_table)  <- c('Start', 'End', 'Commit')
kable(general_infos_table,
      col.names = c('Value'), caption = 'General information', format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r start_arguments}
args_transposed <- as.data.frame(t(args))
kable(args_transposed, col.names = c('value'), caption = 'Start arguments', format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r events_summary}
planned_blocks <- sum(str_count(ticks, 'block'))
planned_txs    <- sum(str_count(ticks, 'tx'))
df             <- data.frame(
                    c(length(ticks), nrow(tick_infos)),
                    c(planned_blocks, nrow(blocks)),
                    c(planned_txs, nrow(txs) - nrow(blocks))
                  )
row.names(df)  <- c('planned', 'run')
kable(df,
      col.names = c('Ticks', 'Blocks', 'Transactions'), caption = 'Events summary', format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

## System

```{r system_information}
kable(Sys.info(), col.names = c('value'), format = 'latex', caption = 'System information') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r system_hardware_specs}
infos <- data.frame(c(general_infos$cpu_model, general_infos$cpus, round(as.double(general_infos$total_memory) / 1000000, 3)))
row.names(infos) <- c('CPU model', 'CPU(s)', 'memory [GB]')
kable(infos, col.names = c('value'), format = 'latex', caption = 'System hardware specs') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r memory_usage_over_time, fig.cap='Memory usage over time', fig.env='figure*'}
memory$usage         <- (1 - memory$free/memory$total) * 100
xyplot(memory$usage ~ memory$timestamp - sim_start, xlab = 'Time [s]', ylab = 'Memory usage [%]', t = 'l' )
```

```{r cpu_usage_over_time, fig.cap='CPU usage over time', fig.env='figure*'}
cpu_time$total           <- cpu_time$user + cpu_time$nice + cpu_time$system
cpu_time_diff           <- data.frame(cpu_time$timestamp[-1], diff(cpu_time$total), diff(cpu_time$idle))
colnames(cpu_time_diff) <- c('timestamp', 'total', 'idle')
cpu_time_diff$usage     <- (1 - cpu_time_diff$idle / (cpu_time_diff$total + cpu_time_diff$idle)) * 100

xyplot(cpu_time_diff$usage ~ cpu_time_diff$timestamp - sim_start, xlab = 'Time [s]', ylab = 'CPU usage [%]', t = 'l' )
```

## Ticks

```{r simulation}
step_diff                      <- data.frame(diff(step_times$timestamp))
colnames(step_diff)            <- c('timestamp')
step_diff_summary              <- rbind(step_diff, apply(step_diff, 2, sum))
step_diff_summary$duration_min <- step_diff_summary$timestamp/60
step_diff_summary              <- step_diff_summary %>%
  mutate_at(.vars = vars(timestamp, duration_min), .funs = funs(round(.,2)))
rownames(step_diff_summary)   <- c('preparation step', 'simulation step', 'postprocessing step', 'total')

kable(step_diff_summary, col.names = c('duration [s]', 'duration [min]'), caption = 'Duration of different steps', format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
```

```{r step_times_barchart, fig.cap='Step times', fig.pos='H', fig.height=3}
step_diff             <- data.frame(diff(step_times$timestamp))
t_step_diff           <- t(step_diff)
colnames(t_step_diff) <- c('preparation', 'simulation', 'postprocessing')
rownames(t_step_diff) <- c('run')
barchart(t_step_diff, stack = TRUE, ref = FALSE, xlab = 'Time [s]', auto.key = list(space='top',text=colnames(t_step_diff)))
```

```{r tick_duration_summary}
kable(unclass(summary(tick_infos$duration)), col.names = c('duration [s]'), digits = 3, caption = 'Tick duration', format = 'latex')  %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r tick_duration_boxplot, fig.cap='Tick duration', fig.pos='H', fig.height=3}
bwplot(tick_infos$duration, xlab='Tick duration [s]')
```

```{r tick_duration_xyplot, fig.cap='Tick duration over time', fig.env='figure*'}
xyplot(tick_infos$duration ~ tick_infos$start - sim_start, xlab = 'Time [s]', ylab = 'Duration [s]', t = 'l' )
```

```{r tick_duration_median, fig.cap='Tick duration over time with boxplot', fig.env='figure*'}
# par(mar=c(7,5,1,1)) # increase plot margins to fit longer labels on the x-axis
# boxplot(tick_infos$duration ~ cut(tick_infos$start - sim_start, 25), las=2)
```

##  Blocks

```{r stale, fig.cap='Accepted/stale blocks', fig.pos='H', fig.height=3}
stale_block <- t(table(blocks$stale))
rownames(stale_block) <- c('run')
legend = paste(paste(colnames(stale_block), prop.table(stale_block)[1,] * 100), '%', sep = '')
barchart(stale_block, stack = TRUE, ref = FALSE, xlab = 'Blocks', auto.key = list(space='top',text=legend))
```

```{r block_size_summary}
kable(unclass(summary(blocks$total_size / 1000)), col.names = c('size [kB]'), digits = 3, caption = 'Block size', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r block_size_boxplot, fig.cap='Block size', fig.pos='H', fig.height=3}
bwplot(blocks$total_size / 1000, xlab='Block size [kb]')
```

```{r block_propagation_summary}
kable(unclass(summary(blocks_received$propagation_duration * 1000)), col.names = c('propagation [ms]'), digits = 3, caption = 'Block propagation', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r block_propagation_density, fig.cap='Block propagation density', fig.env='figure*'}
densityplot(~propagation_duration, data=blocks_received, auto.key = list(space = "right"), ref = TRUE, xlab = 'Duration [s]', plot.points = FALSE)
```

## Transactions

```{r txs_propagation_summary}
kable(unclass(summary(txs_received$propagation_duration * 1000)), col.names = c('propagation [ms]'), digits = 3, caption = 'Transactions propagation', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r tx_propagation_density, fig.cap='Transaction propagation density', fig.env='figure*'}
densityplot(~propagation_duration, data=txs_received, auto.key = list(space = "right"), ref = TRUE, xlab = 'Duration [s]', plot.points = FALSE)
```

```{r txs_per_block_summary}
kable(unclass(summary(blocks$txs)), digits = 0, caption = 'Transactions per block', format = 'latex') %>%
  kable_styling(latex_options = c('HOLD_position'))
```

```{r txs_per_block_boxplot, fig.cap='Transactions in block', fig.pos='H', fig.height=3}
bwplot(blocks$txs, xlab='Transactions')
```

## Nodes

```{r tips}
kable(tips, format = 'latex') %>%
  kable_styling(latex_options = c('scale_down','HOLD_position'))
not_active_tips <- tips[!(tips$status=='active'),]
```

## Block exceptions
There were `r nrow(block_exces)` exceptions catched during the execution of the RPC-call to create a block.

```{r block_exces_hist, eval=nrow(block_exces) > 0, fig.pos='H'}
hist(block_exces$rel_timestamp - sim_start, xlab = 'Time [s]')
```

```{r block_exces_node_distribution, eval=nrow(block_exces) > 0, fig.pos='H'}
exces_per_node <- table(block_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Distribution of exceptions')
```

```{r block_exces_distribution, eval=nrow(block_exces) > 0, , fig.pos='H'}
exces_per_node <- table(block_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Exception types')
```

## Transaction exceptions
There were `r nrow(tx_exces)` exceptions catched during the execution of the RPC-call to send a transaction.

```{r tx_exces, eval=nrow(tx_exces) > 0, fig.pos='H'}
tx_exces$rel_timestamp <- tx_exces$timestamp - sim_start
hist(tx_exces$rel_timestamp, xlab = 'Time [s]')
```

```{r tx_exces_node_distribution, eval=nrow(tx_exces) > 0, fig.pos='H'}
exces_per_node <- table(tx_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Distribution of exceptions')
```

```{r tx_exces_distribution, eval=nrow(tx_exces) > 0, fig.pos='H'}
exces_per_node <- table(tx_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Exception types')
```

## RPC exceptions
There were `r nrow(rpc_exces)` exceptions catched during a RPC-call.

```{r rpc_exces, eval=nrow(rpc_exces) > 0, fig.pos='H'}
rpc_exces$rel_timestamp <- rpc_exces$timestamp - sim_start
hist(rpc_exces$rel_timestamp, xlab = 'Time [s]')
```

```{r rpc_exces_node_distribution, eval=nrow(rpc_exces) > 0, fig.pos='H'}
exces_per_node <- table(rpc_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Distribution of exceptions')
```

```{r rpc_exces_distribution, eval=nrow(rpc_exces) > 0, eval=nrow(rpc_exces), fig.pos='H'}
exces_per_node <- table(rpc_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
title(main = 'Exception type')
```

\clearpage

#### R and package versions used

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
