# Simulation Report

* install dependecies in R with `install.packages("dependency")`
    * rmarkdown
    * anytime
    * dplyr
    * devtools (if installation fails this link may help: [SO - Problems installing the devtools package](https://stackoverflow.com/questions/20923209/problems-installing-the-devtools-package))
    * jsonlite
* make sure pandoc is installed (e.g. apt install pandoc)


```{r knitr_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=4, fig.path='RmdFigs/',
               warning=FALSE, message=FALSE)

# set working directory for development: knitr::opts_knit$set(root.dir = '/tmp/run/postprocessing/')

knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup}
library('jsonlite')
library('anytime')
library('dplyr')

# general infos is needed twice to avoid exception in simulation section.
general_infos <- fromJSON(file('general_infos.json'))
general_info2 <- fromJSON(file('general_infos.json'))
tick_infos    <- read.csv2("tick_infos.csv", dec=".")

txs           <- read.csv2("txs.csv", dec=".")
blocks        <- read.csv2("blocks.csv", dec=".")
mempool       <- read.csv2("mempool_snapshots.csv", dec=".")
nodes         <- read.csv2("nodes.csv", dec=".")

tx_exces      <- read.csv2("tx_exceptions.csv", dec=".")
block_exces   <- read.csv2("block_exceptions.csv", dec=".")
rpc_exces     <- read.csv2("rpc_exceptions.csv", dec=".")
log_errors    <- readChar("log_errors.txt", file.info("log_errors.txt")$size)

args          <- stream_in(file('../args.json'))
sim_start     <- tick_infos$start[1]
```


## Start arguments
```{r read_start_arguments}
args_transposed <- as.data.frame(t(args))
kable(args_transposed, col.names = c('value'))
```

## Simulation
The simulation started at `r utctime(general_info2[['preparation_start']])` and ended at `r utctime(general_info2[['postprocessing_end']])`.

```{r simulation}
general_infos           <- data.frame(t(data.frame(general_infos)))
colnames(general_infos) <- c('timestamp')
general_infos        <- general_infos[ order(general_infos$timestamp), , drop = FALSE]

diff_steps <- data.frame(diff(as.matrix(general_infos)))
diff_steps <- rbind(diff_steps, apply(diff_steps, 2, sum))
diff_steps$duration_min <- diff_steps$timestamp/60
diff_steps <- diff_steps %>% mutate_at(.vars = vars(timestamp, duration_min), .funs = funs(round(.,2)))
rownames(diff_steps)   <- c('preparation step', 'run step', 'postprocessing step (wo. report creation)', '***total***')

kable(diff_steps, align = c('ll'), col.names = c('duration [s]', 'duration [min]'))
```

### Ticks
During the simulation `r if(nrow(tick_infos) == args['amount_of_ticks']) {'all'} else {'only'}` **`r nrow(tick_infos)` of `r args['amount_of_ticks']`** ticks were executed.

```{r ticks}
tick_infos$rel_timestamp <- tick_infos$start - sim_start
```

```{r ticks_stats}
ticks_stats <- data.frame(c('Mean tick duration [s]', 'Median tick duration [s]', 'Std tick duration [s]', 'Min tick duration [s]', 'Max tick duration [s]'))
ticks_stats$values <- c(
  round(mean(tick_infos$duration), 3),
  round(median(tick_infos$duration), 3),
  round(sd(tick_infos$duration), 3),
  round(min(tick_infos$duration), 3),
  round(max(tick_infos$duration), 3)
)

kable(ticks_stats,  align = c('l'), col.names = c('', 'value'))
```

### Tick duration over time
```{r tick_duration_median}
tick_duration_median <- tapply(tick_infos$duration, cut(tick_infos$rel_timestamp, pretty(tick_infos$rel_timestamp)), median)
plot(tick_duration_median, xlab = 'Time [s]', ylab='Duration of tick [s]', xaxt='n')
axis(1, at=1:nrow(tick_duration_median), labels=names(tick_duration_median))
lines(tick_duration_median)
```

##  Blocks
In this simulation `r nrow(blocks)` blocks were created by `r length(unique(blocks$node))` different nodes.

```{r blocks}
blocks$total_size_kb         <- blocks$total_size/1000
blocks$median_propagation_ms <- blocks$median_propagation * 1000
blocks$std_propagation_ms    <- blocks$std_propagation * 1000
blocks$rel_timestamp         <- blocks$timestamp - sim_start
```

### Distribution of blocks over nodes
```{r blocks_distribution, fig.height=6}
blocks_per_node <- table(blocks$node)
percentage <- round(blocks_per_node/sum(blocks_per_node)*100)
labels <- paste(names(blocks_per_node), ' blocks: ', blocks_per_node, ', ', percentage, '%', sep='')
pie(blocks_per_node, labels)
```

### Creation time of blocks
```{r blocks_creation_time}
hist(blocks$rel_timestamp, xlab = 'Time [s]')
```

### Stale blocks
```{r stale, fig.height=6}
stale_blocks <- table(blocks$stale)
percentage <- round(stale_blocks/sum(stale_blocks)*100)
labels <- paste(names(stale_blocks), ' blocks: ', stale_blocks, ', ', percentage, '%', sep='')
pie(stale_blocks, labels)
```

### Size of blocks
```{r block_size_stats}
block_size_stats <- data.frame(c('Mean block size [kB]', 'Median block size [kB]', 'Std block size [kB]', 'Min block size [kB]', 'Max block size [kB]'))
block_size_stats$values <- c(
  round(mean(blocks$total_size_kb), 3),
  round(median(blocks$total_size_kb), 3),
  round(sd(blocks$total_size_kb), 3),
  round(min(blocks$total_size_kb), 3),
  round(max(blocks$total_size_kb), 3)
)

kable(block_size_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r size}
hist(blocks$total_size_kb, xlab = 'Size [kb]')
```

### Block received by other nodes
```{r blocks_received_stats}
blocks_received_stats <- data.frame(c('Mean of block received', 'Median of block received', 'Std of block received', 'Min of blocks received', 'Max of blocks received'))
blocks_received_stats$values <- c(
  round(mean(blocks$received_by), 3),
  round(median(blocks$received_by), 3),
  round(sd(blocks$received_by), 3),
  min(blocks$received_by),
  max(blocks$received_by)
)

kable(blocks_received_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_received}
hist(blocks$received_by, xlab = 'Nodes')
```

### Propagation time of blocks
`r if(!is.na(table(blocks$received_by)['0'])) {paste('*The', table(blocks$received_by)['0'], 'blocks which were never received by another node are not included in this section*', sep=' ')}`

```{r block_propagation_stats}
block_propagation_stats <- data.frame(c('Mean block propagation [ms]', 'Median block propagation [ms]', 'Std block propagation [ms]', 'Min block propagation [ms]', 'Max block propagation [ms]'))
block_propagation_stats$values <- c(
  round(mean(blocks$median_propagation_ms, na.rm = TRUE), 3),
  round(median(blocks$median_propagation_ms, na.rm = TRUE), 3),
  round(sd(blocks$median_propagation_ms, na.rm = TRUE), 3),
  round(min(blocks$median_propagation_ms, na.rm = TRUE), 3),
  round(max(blocks$median_propagation_ms, na.rm = TRUE), 3)
)

kable(block_propagation_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_propagation}
hist(blocks$median_propagation, xlab = 'Median propagation time [ms]')
```

### Standard deviation time of propagation time of blocks
```{r block_std_propagation_stats}
block_std_propagation_stats <- data.frame(c('Mean of std block propagation [ms]', 'Median of std block propagation [ms]', 'Std of std block propagation [ms]', 'Min of std block propagation [ms]', 'Max of std block propagation [ms]'))
block_std_propagation_stats$values <- c(
  round(mean(blocks$std_propagation_ms, na.rm = TRUE), 3),
  round(median(blocks$std_propagation_ms, na.rm = TRUE), 3),
  round(sd(blocks$std_propagation_ms, na.rm = TRUE), 3),
  round(min(blocks$std_propagation_ms, na.rm = TRUE), 3),
  round(max(blocks$std_propagation_ms, na.rm = TRUE), 3)
)

kable(block_std_propagation_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_std_propagation}
hist(blocks$std_propagation, xlab = 'Sandard deviation time [ms]')
```

## Transactions
There were `r nrow(txs)` transaction created in this simulation. `r table(txs$accepted_by)['0']` of `r nrow(txs)` never reached another node.

```{r txs}
txs$rel_timestamp <- txs$timestamp - sim_start
```

### Distribution
```{r txs_distribution, fig.height=6}
txs_per_node <- table(txs$node)
percentage <- round(txs_per_node/sum(txs_per_node)*100)
labels <- paste(names(txs_per_node), ' blocks: ', txs_per_node, ', ', percentage, '%', sep='')
pie(txs_per_node, labels)
```

### Creation time
```{r txs_creation_time}
hist(txs$rel_timestamp, xlab = 'Time [s]')
```

### Transaction acception rate
```{r txs_accepted_by_stats}
txs_accepted_by_stats <- data.frame(c('Mean txs acception rate', 'Median txs acception rate', 'Std txs acception rate', 'Min txs acception rate', 'Max txs acception rate'))
txs_accepted_by_stats$values <- c(
  round(mean(txs$accepted_by), 3),
  round(median(txs$accepted_by), 3),
  round(sd(txs$accepted_by), 3),
  min(txs$accepted_by),
  median(txs$accepted_by)
)

kable(txs_accepted_by_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_accepted_by}
hist(txs$accepted_by, xlab = 'Nodes')
```

### Transaction acception time
`r if(!is.na(table(txs$accepted_by)['0'])) {paste('*The', table(txs$accepted_by)['0'], 'transaction which never reached another node are not included in this section*', sep=' ')}`

```{r txs_median_propagation_stats}
txs_median_propagation <- data.frame(c('Mean of median txs acception time [s]', 'Median of median txs acception time [s]', 'Std of median txs acception time [s]', 'Min of median txs acception time [s]', 'Max of median txs acception time [s]'))
txs_median_propagation$values <- c(
  round(mean(txs$median_propagation, na.rm = TRUE), 3),
  round(median(txs$median_propagation, na.rm = TRUE), 3),
  round(sd(txs$median_propagation, na.rm = TRUE), 3),
  round(min(txs$median_propagation, na.rm = TRUE), 3),
  round(median(txs$median_propagation, na.rm = TRUE), 3)
)

kable(txs_median_propagation,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_median_propagation}
hist(txs$median_propagation, xlab = 'Time [s]')
```

```{r txs_std_propagation_stats}
txs_std_propagation <- data.frame(c('Mean of std txs acception time [s]', 'Median of std txs acception time [s]', 'Std of std txs acception time [s]', 'Min of std txs acception time [s]', 'Max of std txs acception time [s]'))
txs_std_propagation$values <- c(
  round(mean(txs$std_propagation, na.rm = TRUE), 3),
  round(median(txs$std_propagation, na.rm = TRUE), 3),
  round(sd(txs$std_propagation, na.rm = TRUE), 3),
  round(min(txs$std_propagation, na.rm = TRUE), 3),
  round(median(txs$std_propagation, na.rm = TRUE), 3)
)

kable(txs_std_propagation,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_std_propagation}
hist(txs$std_propagation, xlab = 'Time [s]')
```

### Transactions per block
```{r txs_per_block_stats}
txs_per_block_stats <- data.frame(c('Mean transactions per block', 'Median transactions per block', 'Std transactions per block', 'Min transactions per block', 'Max transactions per block'))
txs_per_block_stats$values <- c(
  round(mean(blocks$txs), 3),
  round(median(blocks$txs), 3),
  round(sd(blocks$txs), 3),
  min(blocks$txs),
  max(blocks$txs)
)

kable(txs_per_block_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_per_block}
hist(blocks$txs, xlab = 'Transactions')
```

## Mempool snapshots
There were `r nrow(mempool)` mempool snapshots parsed from log file.

```{r mempool_stats}
mempool_stats <- data.frame(c('Mean transactions in mempool', 'Median transactions in mempool', 'Std transactions in mempool', 'Min transactions in mempool', 'Max transactions in mempool'))
mempool_stats$values <- c(
  round(mean(mempool$txs), 3),
  round(median(mempool$txs), 3),
  round(sd(mempool$txs), 3),
  min(mempool$txs),
  max(mempool$txs)
)

kable(mempool_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r mempool_txs}
hist(mempool$txs, xlab = 'Transactions')
```

### Transactions in mempool over time
```{r txs_mempool_over_time}
mempool$rel_timestamp <- mempool$timestamp - sim_start
txs_in_mempool = tapply(mempool$txs, cut(mempool$rel_timestamp, pretty(mempool$rel_timestamp)), median)
plot(txs_in_mempool, xlab = 'Time [s]', ylab='Transactions', xaxt='n')
axis(1, at=1:nrow(txs_in_mempool), labels=names(txs_in_mempool))
lines(txs_in_mempool)
```

## Nodes
In this simulation were `r nrow(nodes)` nodes. In the following the statistics based on data from the RPC-call `getchaintips` are presented.

### All different tip types
```{r all types}
total           <- cbind(nodes['total_tips'], nodes['total_tips_median_branchlen'], nodes['total_tips_std_branchlen'])
total           <- rbind(total, apply(total, 2, mean))

rownames(total) <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(total)
```

### Valid forks
```{r valid_forks}
valid_forks           <- cbind(nodes['valid_fork'], nodes['valid_fork_median_branchlen'], nodes['valid_fork_std_branchlen'])
valid_forks           <- rbind(valid_forks, apply(valid_forks, 2, mean))

rownames(valid_forks) <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_forks)
```

### Headers only
```{r headers_only}
headers_only           <- cbind(nodes['headers_only'], nodes['headers_only_median_branchlen'], nodes['headers_only_std_branchlen'])
headers_only           <- rbind(headers_only, apply(headers_only, 2, mean))

rownames(headers_only) <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(headers_only)
```

### Valid headers
```{r valid_headers}
valid_headers           <- cbind(nodes['valid_headers'], nodes['valid_headers_median_branchlen'], nodes['valid_headers_std_branchlen'])
valid_headers           <- rbind(valid_headers, apply(valid_headers, 2, mean))

rownames(valid_headers) <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_headers)
```


## Block exceptions
There were `r nrow(block_exces)` exceptions catched during the execution of the RPC-call to create a block.

```{r block_exces}
block_exces$rel_timestamp <- block_exces$timestamp - sim_start
```

```{r block_exces_hist}
hist(block_exces$rel_timestamp, xlab = 'Time [s]')
```

### Distribution
```{r block_exces_node_distribution, fig.height=6}
exces_per_node <- table(block_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r block_exces_distribution, fig.height=6}
exces_per_node <- table(block_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Transaction exceptions
There were `r nrow(tx_exces)` exceptions catched during the execution of the RPC-call to send a transaction.

```{r tx_exces}
tx_exces$rel_timestamp <- tx_exces$timestamp - sim_start
hist(tx_exces$rel_timestamp, xlab = 'Time [s]')
```

### Distribution
```{r tx_exces_node_distribution, fig.height=6}
exces_per_node <- table(tx_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r tx_exces_distribution, fig.height=6}
exces_per_node <- table(tx_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## RPC exceptions
There were `r nrow(rpc_exces)` exceptions catched during a RPC-call.

```{r rpc_exces}
rpc_exces$rel_timestamp <- rpc_exces$timestamp - sim_start
hist(rpc_exces$rel_timestamp, xlab = 'Time [s]')
```

### Distribution
```{r rpc_exces_node_distribution, fig.height=6}
exces_per_node <- table(rpc_exces$node)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r rpc_exces_distribution, fig.height=6}
exces_per_node <- table(rpc_exces$exception)
percentage     <- round(exces_per_node/sum(exces_per_node)*100)
labels         <- paste(names(exces_per_node), ': ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Log errors
Presenting all lines from the log files which matched suspicious strings like `ERROR`, `Exception` and so on.

```
`r log_errors`
```

#### R and package versions used

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
