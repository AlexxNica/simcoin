# Simulation Report

* install dependecies in R with `install.packages("dependency")`
    * rmarkdown
    * devtools (if installation fails this link may help: [SO - Problems installing the devtools package](https://stackoverflow.com/questions/20923209/problems-installing-the-devtools-package))
    * jsonlite
* make sure pandoc is installed (e.g. apt install pandoc)


```{r knitr_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=4, fig.path='RmdFigs/',
               warning=FALSE, message=FALSE)

# set working directory for development: knitr::opts_knit$set(root.dir = '/tmp/run')
```

### Data import

We will consider data from [Simcoin et al., Physiol Genomics 10:5&ndash;12,
2017](http://www.ncbi.nlm.nih.gov/pubmed/12118100).

```{r setup, include=FALSE}
txs           <- read.csv2("txs.csv", dec=".")
blocks        <- read.csv2("blocks.csv", dec=".")
mempool       <- read.csv2("mempool_snapshots.csv", dec=".")
nodes         <- read.csv2("nodes.csv", dec=".")
tx_exces      <- read.csv2("tx_exceptions.csv", dec=".")
block_exces   <- read.csv2("block_exceptions.csv", dec=".")
tick_infos    <- read.csv2("tick_infos.csv", dec=".")

library('jsonlite')
args    <- stream_in(file('args.json'))
```


## Start arguments
```{r read_start_arguments, echo=FALSE}
args_transposed = as.data.frame(t(args))
kable(args_transposed, col.names = c('value'))
```


## Simulation

`r if(nrow(tick_infos) == args['amount_of_ticks']) {'All'} else {'Some'}` ticks (`r nrow(tick_infos)`/`r args['amount_of_ticks']`) of the simulation were executed.

##  Blocks

There were `r nrow(blocks)` blocks in this simulation.

### Distribution
```{r blocks_distribution, error=TRUE, fig.height=6}
blocks_per_node <- table(blocks$node)
percentage <- round(blocks_per_node/sum(blocks_per_node)*100)
labels <- paste(names(blocks_per_node), ' blocks: ', blocks_per_node, ', ', percentage, '%', sep='')
pie(blocks_per_node, labels)
```

### Creation time
```{r blocks_creation_time, error=TRUE}
tick_infos$tick_duration = as.numeric(args['tick_duration']) - tick_infos$sleep_time
tick_infos$rel_timestamp = tick_infos$timestamp - range(tick_infos$timestamp)[1]

blocks$rel_timestamp = blocks$timestamp - range(blocks$timestamp)[1]
hist(blocks$rel_timestamp)

```

### Stale blocks
```{r stale, error=TRUE, fig.height=6}
stale_blocks <- table(blocks$stale)
percentage <- round(stale_blocks/sum(stale_blocks)*100)
labels <- paste(names(stale_blocks), ' blocks: ', stale_blocks, ', ', percentage, '%', sep='')
pie(stale_blocks, labels)
```

### Block size

```{r block_size_stats, error=TRUE}
block_size_stats <- data.frame(c('mean block size [kB]', 'median block size [kB]', 'std block size [kB]'))
block_size_stats$values <- c(
  round(mean(blocks$total_size)/1000, 3),
  round(median(blocks$total_size)/1000, 3),
  round(sd(blocks$total_size)/1000, 3)
)

kable(block_size_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r size, error=TRUE}
hist(blocks$total_size)
```

### Blocks received

```{r blocks_received_stats, error=TRUE}
blocks_received_stats <- data.frame(c('mean blocks received', 'median blocks received', 'std blocks received'))
blocks_received_stats$values <- c(
  round(mean(blocks$total_received), 3),
  round(median(blocks$total_received), 3),
  round(sd(blocks$total_received), 3)
)

kable(blocks_received_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_received, error=TRUE}
hist(blocks$total_received)
```

### Propagation time of blocks

```{r block_propagation_stats, error=TRUE}
block_propagation_stats <- data.frame(c('mean block propagation [ms]', 'median block propagation [ms]', 'std block propagation [ms]'))
block_propagation_stats$values <- c(
  round(mean(blocks$median_propagation)*1000, 3),
  round(median(blocks$median_propagation)*1000, 3),
  round(sd(blocks$median_propagation)*1000, 3)
)

kable(block_propagation_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_propagation, error=TRUE}
hist(blocks$median_propagation)
```

### Standard deviation time of propagation time of blocks

```{r block_std_propagation_stats, error=TRUE}
block_std_propagation_stats <- data.frame(c('mean of std block propagation [ms]', 'median of std block propagation [ms]', 'std of std block propagation [ms]'))
block_std_propagation_stats$values <- c(
  round(mean(blocks$std_propagation)*1000, 3),
  round(median(blocks$std_propagation)*1000, 3),
  round(sd(blocks$std_propagation)*1000, 3)
)

kable(block_std_propagation_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r blocks_std_propagation, error=TRUE}
hist(blocks$std_propagation)
```

## Block exceptions

There were `r nrow(block_exces)` exceptions during the creation of blocks.

```{r block_exces, error=TRUE}
block_exces$rel_timestamp = block_exces$timestamp - range(block_exces$timestamp)[1]
hist(block_exces$rel_timestamp)
```

### Distribution
```{r block_exces_node_distribution, error=TRUE, fig.height=6}
exces_per_node <- table(block_exces$node)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r block_exces_error_message_distribution, error=TRUE, fig.height=6}
exces_per_node <- table(block_exces$error_message)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Transactions

There were `r nrow(txs)` txs in this simulation.

### Distribution
```{r txs_distribution, error=TRUE, fig.height=6}
txs_per_node <- table(txs$node)
percentage <- round(txs_per_node/sum(txs_per_node)*100)
labels <- paste(names(txs_per_node), ' blocks: ', txs_per_node, ', ', percentage, '%', sep='')
pie(txs_per_node, labels)
```

### Creation time
```{r txs_creation_time, error=TRUE}
txs$rel_timestamp = txs$timestamp - range(txs$timestamp)[1]
hist(txs$rel_timestamp)
```

### Txs accepted

```{r txs_accepted_stats, error=TRUE}
txs_accepted_stats <- data.frame(c('mean txs acception rate', 'median txs acception rate', 'std txs acception rate'))
txs_accepted_stats$values <- c(
  round(mean(txs$std_propagation), 3),
  round(median(txs$std_propagation), 3),
  round(sd(txs$std_propagation), 3)
)

kable(txs_accepted_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_accepted, error=TRUE}
hist(txs$total_accepted)
```


### Transaction median propagation
```{r txs_median_propagation, error=TRUE}
hist(txs$median_propagation, breaks=10)
```

### Transactions per block
```{r txs_per_block_stats, error=TRUE}
txs_per_block_stats <- data.frame(c('mean txs per block', 'median txs per block', 'std txs per block'))
txs_per_block_stats$values <- c(
  round(mean(blocks$txs), 3),
  round(median(blocks$txs), 3),
  round(sd(blocks$txs), 3)
)

kable(txs_per_block_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r txs_per_block, error=TRUE}
hist(blocks$txs)
```

## Transaction exceptions

There were `r nrow(tx_exces)` exceptions during the creation of the transactions.

```{r tx_exces, error=TRUE}
tx_exces$rel_timestamp = tx_exces$timestamp - range(tx_exces$timestamp)[1]
hist(tx_exces$rel_timestamp)
```

### Distribution
```{r tx_exces_node_distribution, error=TRUE, fig.height=6}
exces_per_node <- table(tx_exces$node)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r tx_exces_error_message_distribution, error=TRUE, fig.height=6}
exces_per_node <- table(tx_exces$error_message)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Ticks

```{r calc_tick_duration, error=TRUE>0, include=FALSE}
tick_duration = tapply(tick_infos$tick_duration, cut(tick_infos$rel_timestamp, pretty(tick_infos$rel_timestamp)), median)
```
During the simulation `r nrow(tick_infos)` ticks were executed.

```{r ticks_stats, error=TRUE>0}
ticks_stats <- data.frame(c('mean tick duration [s]', 'median tick duration [s]', 'std tick duration [s]'))
ticks_stats$values <- c(
  round(mean(tick_infos$tick_duration), 3),
  round(median(tick_infos$tick_duration), 3),
  round(sd(tick_infos$tick_duration), 3)
)

kable(ticks_stats,  align = c('l'), col.names = c('', 'value'))
```

### Tick duration over time

```{r tick_duration, error=TRUE>0}
tick_duration = tapply(tick_infos$tick_duration, cut(tick_infos$rel_timestamp, pretty(tick_infos$rel_timestamp)), median)
plot(tick_duration, xlab='time [s]', ylab='duration of tick [s]', xaxt='n')
axis(1, at=1:nrow(tick_duration), labels=names(tick_duration))
lines(tick_duration)
```

## Mempool snapshots

There were `r nrow(mempool)` mempool snapshots parsed from log file.

```{r mempool_stats, error=TRUE}
mempool_stats <- data.frame(c('mean tick duration [s]', 'median tick duration [s]', 'std tick duration [s]'))
mempool_stats$values <- c(
  round(mean(mempool$txs), 3),
  round(median(mempool$txs), 3),
  round(sd(mempool$txs), 3)
)

kable(mempool_stats,  align = c('l'), col.names = c('', 'value'))
```

```{r mempool_txs, error=TRUE}
hist(mempool$txs)
```

### Txs in mempool over time

```{r txs_mempool_over_time, error=TRUE}
mempool$rel_timestamp = mempool$timestamp - range(mempool$timestamp)[1]
txs_in_mempool = tapply(mempool$txs, cut(mempool$rel_timestamp, pretty(mempool$rel_timestamp)), median)
plot(txs_in_mempool, xlab='time [s]', ylab='txs', xaxt='n')
axis(1, at=1:nrow(txs_in_mempool), labels=names(txs_in_mempool))
lines(txs_in_mempool)
```

## Nodes

In this simulation were `r nrow(nodes)` nodes. In the following the statistics based on data from the RPC-call `getchaintips` are presented.

### All different tips types

```{r all types}
total             <- cbind(nodes['total_tips'], nodes['total_tips_median_branchlen'], nodes['total_tips_std_branchlen'])
total             <- rbind(total, apply(total, 2, mean))

rownames(total)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(total)
```

### Valid forks

```{r valid_forks}
valid_forks             <- cbind(nodes['valid_fork'], nodes['valid_fork_median_branchlen'], nodes['valid_fork_std_branchlen'])
valid_forks             <- rbind(valid_forks, apply(valid_forks, 2, mean))

rownames(valid_forks)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_forks)
```

### Headers only

```{r headers_only}
headers_only             <- cbind(nodes['headers_only'], nodes['headers_only_median_branchlen'], nodes['headers_only_std_branchlen'])
headers_only             <- rbind(headers_only, apply(headers_only, 2, mean))

rownames(headers_only)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(headers_only)
```

### Valid headers

```{r valid_headers}
valid_headers             <- cbind(nodes['valid_headers'], nodes['valid_headers_median_branchlen'], nodes['valid_headers_std_branchlen'])
valid_headers             <- rbind(valid_headers, apply(valid_headers, 2, mean))

rownames(valid_headers)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_headers)
```


#### R and package versions used

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
