# Simulation Report

* install dependecies in R with `install.packages("dependency")`
    * rmarkdown
    * devtools (if installation fails this link may help: [SO - Problems installing the devtools package](https://stackoverflow.com/questions/20923209/problems-installing-the-devtools-package))
    * jsonlite
* make sure pandoc is installed (e.g. apt install pandoc)


```{r knitr_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=4, fig.path='RmdFigs/',
               warning=FALSE, message=FALSE)

# set working directory for development: knitr::opts_knit$set(root.dir = '/tmp/run')
```

### Data import

We will consider data from [Simcoin et al., Physiol Genomics 10:5&ndash;12,
2017](http://www.ncbi.nlm.nih.gov/pubmed/12118100).

```{r setup, include=FALSE}
txs           <- read.csv2("txs.csv", dec=".")
blocks        <- read.csv2("blocks.csv", dec=".")
mempool       <- read.csv2("mempool_snapshots.csv", dec=".")
nodes         <- read.csv2("nodes.csv", dec=".")
tx_exces      <- read.csv2("tx_exceptions.csv", dec=".")
block_exces   <- read.csv2("block_exceptions.csv", dec=".")
tick_infos    <- read.csv2("tick_infos.csv", dec=".")

library('jsonlite')
args    <- stream_in(file('args.json'))
```


## Start arguments
```{r read_start_arguments, echo=FALSE}
args_transposed = as.data.frame(t(args))
kable(as.data.frame(args_transposed), col.names = c('value'))
```


## Simulation

`r if(nrow(tick_infos) == args['amount_of_ticks']) {'All'} else {'Some'}` ticks (`r nrow(tick_infos)`/`r args['amount_of_ticks']`) of the simulation were executed.

##  Blocks

There were `r nrow(blocks)` blocks in this simulation.

### Distribution
```{r blocks_distribution, eval=nrow(blocks)>0, fig.height=6}
tick_infos$tick_duration = as.numeric(args['tick_duration']) - tick_infos$sleep_time

blocks_per_node <- table(blocks$node)
percentage <- round(blocks_per_node/sum(blocks_per_node)*100)
labels <- paste(names(blocks_per_node), ' blocks: ', blocks_per_node, ', ', percentage, '%', sep='')
pie(blocks_per_node, labels)
```

### Creation time
```{r blocks_creation_time, eval=nrow(blocks)>0}
tick_infos$rel_timestamp = tick_infos$timestamp - range(tick_infos$timestamp)[1]

blocks$rel_timestamp = blocks$timestamp - range(blocks$timestamp)[1]
hist(blocks$rel_timestamp)

```

### Stale blocks
```{r stale, eval=nrow(blocks)>0, fig.height=6}
stale_blocks <- table(blocks$stale)
percentage <- round(stale_blocks/sum(stale_blocks)*100)
labels <- paste(names(stale_blocks), ' blocks: ', stale_blocks, ', ', percentage, '%', sep='')
pie(stale_blocks, labels)
```

### Block size

Mean: `r round(mean(blocks$total_size)/1000, 3)` kB

Median: `r round(median(blocks$total_size)/1000, 3)` kB

Standard deviation: `r round(sd(blocks$total_size)/1000, 3)` kB

```{r size, eval=nrow(blocks)>0}
hist(blocks$total_size)
```

### Blocks received
Mean: `r round(mean(blocks$total_received), 3)` nodes

Median: `r round(median(blocks$total_received), 3)` nodes

Standard deviation: `r round(sd(blocks$total_received), 3)` nodes

```{r blocks_received, eval=nrow(blocks)>0}
hist(blocks$total_received)
```

### Propagation time of blocks

Mean: `r round(mean(blocks$median_propagation)*1000, 3)` ms

Median: `r round(median(blocks$median_propagation)*1000, 3)` ms

Standard deviation: `r round(sd(blocks$median_propagation)*1000, 3)` ms

```{r blocks_propagation, eval=nrow(blocks)>0}
hist(blocks$median_propagation)
```

### Standard deviation time of propagation time of blocks

Mean: `r round(mean(blocks$std_propagation)*1000, 3)` ms

Median: `r round(median(blocks$std_propagation)*1000, 3)` ms

Standard deviation: `r round(sd(blocks$std_propagation)*1000, 3)` ms

```{r blocks_std_propagation, eval=nrow(blocks)>0}
hist(blocks$std_propagation)
```

## Block exceptions

There were `r nrow(block_exces)` exceptions during the creation of blocks.

```{r block_exces, eval=nrow(block_exces)>0}
block_exces$rel_timestamp = block_exces$timestamp - range(block_exces$timestamp)[1]
hist(block_exces$rel_timestamp)
```

### Distribution
```{r block_exces_node_distribution, eval=nrow(block_exces)>0, fig.height=6}
exces_per_node <- table(block_exces$node)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r block_exces_error_message_distribution, eval=nrow(block_exces)>0, fig.height=6}
exces_per_node <- table(block_exces$error_message)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Transactions

There were `r nrow(txs)` txs in this simulation.

### Distribution
```{r txs_distribution, eval=nrow(txs)>0, fig.height=6}
txs_per_node <- table(txs$node)
percentage <- round(txs_per_node/sum(txs_per_node)*100)
labels <- paste(names(txs_per_node), ' blocks: ', txs_per_node, ', ', percentage, '%', sep='')
pie(txs_per_node, labels)
```

### Creation time
```{r txs_creation_time, eval=nrow(txs)>0}
txs$rel_timestamp = txs$timestamp - range(txs$timestamp)[1]
hist(txs$rel_timestamp)
```

### Txs accepted
Mean: `r round(mean(txs$total_accepted), 3)` nodes

Median: `r round(median(txs$total_accepted), 3)` nodes

Standard deviation: `r round(sd(txs$total_accepted), 3)` nodes

```{r txs_accepted, eval=nrow(txs)>0}
hist(txs$total_accepted)
```


### Transaction median propagation
```{r txs_median_propagation, eval=nrow(txs)>0}
hist(txs$median_propagation, breaks=10)
```

### Transactions per block
Mean: `r round(mean(blocks$txs), 3)` txs

Median: `r round(median(blocks$txs), 3)` txs

Standard deviation: `r round(sd(blocks$txs), 3)` txs

```{r txs_per_block, eval=nrow(blocks)>0}
hist(blocks$txs)
```

## Transaction exceptions

There were `r nrow(tx_exces)` exceptions during the creation of the transactions.

```{r tx_exces, eval=nrow(tx_exces)>0}
tx_exces$rel_timestamp = tx_exces$timestamp - range(tx_exces$timestamp)[1]
hist(tx_exces$rel_timestamp)
```

### Distribution
```{r tx_exces_node_distribution, eval=nrow(tx_exces)>0, fig.height=6}
exces_per_node <- table(tx_exces$node)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

### Exception error message
```{r tx_exces_error_message_distribution, eval=nrow(tx_exces)>0, fig.height=6}
exces_per_node <- table(tx_exces$error_message)
percentage <- round(exces_per_node/sum(exces_per_node)*100)
labels <- paste(names(exces_per_node), ' blocks: ', exces_per_node, ', ', percentage, '%', sep='')
pie(exces_per_node, labels)
```

## Ticks

During the simulation `r nrow(tick_infos)` ticks were executed.

`r tick_infos$tick_duration`

Mean: `r round(mean(tick_infos$tick_duration), 3)` s

Median: `r round(median(tick_infos$tick_duration), 3)` s

Standard deviation: `r round(sd(tick_infos$tick_duration), 3)` s

### Tick duration over time

```{r tick_duration, eval=nrow(tick_infos)>0}
tick_duration = tapply(tick_infos$tick_duration, cut(tick_infos$rel_timestamp, pretty(tick_infos$rel_timestamp)), median)
plot(tick_duration, xlab='time', ylab='duration of tick')
```

## Mempool snapshots

There were `r nrow(mempool)` mempool snapshots parsed from log file.

Mean: `r round(mean(mempool$txs), 3)` txs

Median: `r round(median(mempool$txs), 3)` txs

Standard deviation: `r round(sd(mempool$txs), 3)` txs

```{r mempool_txs, eval=nrow(mempool)>0}
hist(mempool$txs)
```

### Txs in mempool over time

```{r txs_mempool_over_time, eval=nrow(mempool)>0}
mempool$rel_timestamp = mempool$timestamp - range(mempool$timestamp)[1]
txs_in_mempool = tapply(mempool$txs, cut(mempool$rel_timestamp, pretty(mempool$rel_timestamp)), median)
plot(txs_in_mempool, xlab='time', ylab='txs')
```

## Nodes

In this simulation were `r nrow(nodes)` nodes. In the following the statistics based on data from the RPC-call `getchaintips` are presented.

### All different tips types

```{r all types}
total             <- cbind(nodes['total_tips'], nodes['total_tips_median_branchlen'], nodes['total_tips_std_branchlen'])
total             <- rbind(total, apply(total, 2, mean))

rownames(total)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(total)
```

### Valid forks

```{r valid_forks}
valid_forks             <- cbind(nodes['valid_fork'], nodes['valid_fork_median_branchlen'], nodes['valid_fork_std_branchlen'])
valid_forks             <- rbind(valid_forks, apply(valid_forks, 2, mean))

rownames(valid_forks)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_forks)
```

### Headers only

```{r headers_only}
headers_only             <- cbind(nodes['headers_only'], nodes['headers_only_median_branchlen'], nodes['headers_only_std_branchlen'])
headers_only             <- rbind(headers_only, apply(headers_only, 2, mean))

rownames(headers_only)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(headers_only)
```

### Valid headers

```{r valid_headers}
valid_headers             <- cbind(nodes['valid_headers'], nodes['valid_headers_median_branchlen'], nodes['valid_headers_std_branchlen'])
valid_headers             <- rbind(valid_headers, apply(valid_headers, 2, mean))

rownames(valid_headers)   <- c(as.character(unlist(nodes['name'])), '***mean***')

kable(valid_headers)
```


#### R and package versions used

```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()
```
